name: Test
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  main:
    uses: bsm/misc/.github/workflows/test-go.yml@main
    with:
      working-directory: .
  ftp-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: bsm/misc/.github/actions/lint-go@main
        with:
          working-directory: bfsftp
  ftp-test:
    runs-on: ubuntu-latest
    services:
      ftp_server:
        image: delfer/alpine-ftp-server
        ports:
          - 7021:21
          - 21000-21010:21000-21010
        env:
          USERS: "ftpuser|ftppass"
    steps:
      - uses: bsm/misc/.github/actions/test-go@main
        with:
          working-directory: bfsftp
  scp-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: bsm/misc/.github/actions/lint-go@main
        with:
          working-directory: bfsscp
  scp-test:
    runs-on: ubuntu-latest
    services:
      ssh_server:
        image: sickp/alpine-sshd:7.5-r2
        ports:
          - 7022:22
    steps:
      - uses: bsm/misc/.github/actions/test-go@main
        with:
          working-directory: bfsscp
  s3-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: bsm/misc/.github/actions/lint-go@main
        with:
          working-directory: bfss3
  s3-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      localstack:
        image: localstack/localstack:stable
        env:
          LS_LOG: warn
        ports:
          - 4566:4566
        volumes:
          - ./bfss3/testdata/init-s3.py:/etc/localstack/init/ready.d/init-s3.py
    steps:
      - uses: bsm/misc/.github/actions/test-go@main
        with:
          working-directory: bfss3
  # gs:
  #   uses: bsm/misc/.github/workflows/test-go.yaml@main
  #   with:
  #     working-directory: bfsgs
